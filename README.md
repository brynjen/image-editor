# Image Editor with Serverpod Backend

A Flutter image editor application with a Serverpod backend that allows users to upload images, process them with AI image processors, and manage them through a modern UI.

## 🏗️ Architecture

- **Frontend**: Flutter app with BLoC state management
- **Backend**: Serverpod server with PostgreSQL database
- **Storage**: Local file storage with database metadata
- **Processing**: AI image processors (qwen3-image-edit, nano-banana, etc.)

## 🚀 Quick Start

### Prerequisites

- Flutter SDK (3.9.0+)
- Dart SDK (3.9.0+)
- Docker and Docker Compose
- Git

### 1. Clone and Setup

```bash
git clone <your-repo-url>
cd image-editor
```

### 2. Install Flutter Dependencies

```bash
flutter pub get
```

**Important:** The Flutter app uses the generated Serverpod client via path dependency. The protocol files are automatically generated by Serverpod and should never be manually copied or modified.

### 3. Start Serverpod Backend

```bash
# Navigate to server directory
cd image_editor_server/image_editor_server_server

# Start database and Redis with Docker
docker compose up --build --detach

# Wait a few seconds for services to start, then run migrations and start server
dart bin/main.dart --apply-migrations
```

**Expected Output:**
```
SERVERPOD version: 2.9.1, dart: 3.9.0
runMode: development
serverId: default
Latest database migration already applied.
Insights listening on port 8081
Server default listening on port 8080
Webserver listening on port 8082
```

The server will start on `http://localhost:8080`

**Verification:** Test the server with:
```bash
curl "http://localhost:8080/greeting/hello?name=Test"
# Should return: {"message":"Hello Test","author":"Serverpod","timestamp":"..."}
```

**To run in background:**
```bash
# Run server in background (optional)
dart bin/main.dart --apply-migrations > server.log 2>&1 &

# Check if running
curl -s http://localhost:8080
# Should return: OK 2025-08-27 14:14:36.439003Z
```

### 4. Run Flutter App

Open a new terminal:

```bash
cd /Users/brynjenordli/git/image-editor
flutter run
```

**Note:** Make sure you're in the main project directory (where `pubspec.yaml` is located), not in the server subdirectory.

## 📱 How to Use

### Upload Images
1. **Drag & Drop**: Drag an image file into the "Input Image" box
2. **Click to Select**: Click the "Input Image" box to browse and select an image
3. **Automatic Upload**: The image will automatically upload to the Serverpod server

### Process Images
1. **Select Processor**: Choose an AI processor from the dropdown (qwen3-image-edit, nano-banana, etc.)
2. **Enter Instructions**: Type what you want the processor to do with the image
3. **Process**: Click "Process Image" to send the request to the server
4. **View Result**: The processed image will appear in the "Output Image" box

## 🛠️ Development

### Serverpod Workflow

**Important:** Always follow the proper Serverpod development workflow:

1. **Modify Protocol Files**: Edit `.yaml` files in `image_editor_server/image_editor_server_server/lib/src/protocol/`
2. **Generate Code**: Run `serverpod generate` from the server directory
3. **Client Updates**: The Flutter app automatically uses the generated client via path dependency

**Never manually copy or modify generated protocol files!**

```bash
# When making changes to protocols:
cd image_editor_server/image_editor_server_server
serverpod generate

# The client is automatically updated via pubspec.yaml path dependency:
# image_editor_server_client:
#   path: ./image_editor_server/image_editor_server_client
```

### Project Structure

```
image-editor/
├── lib/                          # Flutter app source
│   ├── data/                     # Data layer
│   │   ├── dto/                  # Serverpod client protocols
│   │   └── repository/           # Repository implementations
│   ├── domain/                   # Business logic
│   │   ├── model/                # Domain models
│   │   └── repository/           # Repository interfaces
│   └── presentation/             # UI layer
│       ├── bloc/                 # State management
│       ├── screen/               # App screens
│       └── widget/               # Reusable widgets
│
├── image_editor_server/          # Serverpod backend
│   ├── image_editor_server_server/    # Server implementation
│   │   ├── lib/src/endpoints/    # API endpoints
│   │   ├── lib/src/protocol/     # Data models
│   │   ├── migrations/           # Database migrations
│   │   └── storage/              # File storage
│   ├── image_editor_server_client/    # Generated client
│   └── image_editor_server_flutter/   # Example Flutter app
```

### Key Components

#### Backend (Serverpod)
- **ImageEndpoint**: Handles image upload, retrieval, and processing
- **ImageData**: Database model for image metadata
- **File Storage**: Images stored in `storage/images/`
- **Database**: PostgreSQL with automatic migrations

#### Frontend (Flutter)
- **ImageEditorBloc**: Manages application state
- **ImageRepository**: Abstracts server communication
- **ImageModel**: Domain model with server integration
- **ImageDropBox**: Drag & drop image upload widget

### API Endpoints

The Serverpod server exposes these endpoints:

- `POST /image/uploadImage` - Upload an image file
- `GET /image/getImage/{id}` - Get image metadata
- `GET /image/getImageFile/{id}` - Get image file bytes
- `POST /image/processImage` - Process an image with AI
- `GET /image/listImages` - List all uploaded images

## 🔧 Configuration

### Server Configuration

Edit `image_editor_server/image_editor_server_server/config/development.yaml`:

```yaml
# Database settings
database:
  host: localhost
  port: 5432
  name: image_editor
  username: postgres
  password: password

# Server settings
apiServer:
  port: 8080
  publicHost: localhost
```

### Client Configuration

The Flutter app connects to the server at `localhost:8080` by default. To change this, edit `lib/data/repository/serverpod_client_config.dart`:

```dart
static const String _defaultHost = 'localhost';
static const int _defaultPort = 8080;
```

## 📊 Database Schema

### ImageData Table

| Column | Type | Description |
|--------|------|-------------|
| id | int | Primary key (auto-increment) |
| filename | String | Unique server filename |
| originalName | String | Original uploaded filename |
| mimeType | String | Image MIME type |
| size | int | File size in bytes |
| uploadedAt | DateTime | Upload timestamp |
| processorType | String? | AI processor used |
| instructions | String? | Processing instructions |
| processedAt | DateTime? | Processing timestamp |
| processedFilename | String? | Processed image filename |

## 🧪 Testing

### System Verification

**1. Backend Server Test:**
```bash
cd image_editor_server/image_editor_server_server
dart bin/main.dart --apply-migrations

# Expected output:
# SERVERPOD version: 2.9.1
# Server default listening on port 8080
# Webserver listening on port 8082
```

**2. API Endpoint Test:**
```bash
curl "http://localhost:8080/greeting/hello?name=Test"
# Expected: {"message":"Hello Test","author":"Serverpod","timestamp":"..."}

curl -s http://localhost:8080
# Expected: OK 2025-08-27 14:14:36.439003Z
```

**3. Database Test:**
```bash
docker ps
# Should show: postgres, redis containers running

docker compose logs postgres | tail -5
# Should show: database system is ready to accept connections
```

### Manual Testing
1. Start the backend server
2. Run the Flutter app: `flutter run`
3. Upload various image formats (JPG, PNG, GIF, WebP)
4. Test image processing with different processors
5. Verify images are stored in `storage/images/`
6. Check server logs for upload confirmations

### Automated Testing
```bash
# Run Flutter tests
flutter test

# Run server tests
cd image_editor_server/image_editor_server_server
dart test
```

## 🐛 Troubleshooting

### Common Issues

#### Server won't start
- Check if Docker is running: `docker ps`
- Check if ports 8080 and 5432 are available
- View server logs: `docker compose logs`

#### Database connection errors
- Wait for PostgreSQL to fully start (30 seconds)
- Check database credentials in config files
- Restart Docker containers: `docker compose restart`

#### Image upload fails
- Check server logs for errors
- Verify `storage/images/` directory exists and is writable
- Check network connectivity to `localhost:8080`

#### Flutter build errors
- Run `flutter clean && flutter pub get`
- Check Dart/Flutter SDK versions
- Verify all dependencies are installed

### Logs

#### Server Logs
```bash
cd image_editor_server/image_editor_server_server
dart bin/main.dart --apply-migrations --verbose
```

#### Docker Logs
```bash
docker compose logs -f postgres
docker compose logs -f redis
```

## 📝 License

This project is licensed under the MIT License - see the LICENSE file for details.

## 🤝 Contributing

1. Fork the repository
2. Create a feature branch (`git checkout -b feature/amazing-feature`)
3. Commit your changes (`git commit -m 'Add some amazing feature'`)
4. Push to the branch (`git push origin feature/amazing-feature`)
5. Open a Pull Request

## 📞 Support

For support and questions:
- Create an issue in the GitHub repository
- Check the troubleshooting section above
- Review Serverpod documentation: https://serverpod.dev
- Review Flutter documentation: https://docs.flutter.dev